<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hospital Management System</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --color-primary:#3b5998;
      --color-primary-light:#f8f9fa;
      --color-accent:#008080;
      --color-accent-light:#4db8b8;
      --color-hover-transition:all .3s ease-in-out;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column;min-height:100vh;background:var(--color-primary-light)!important}
    .bg-primary-dark{background:var(--color-primary)!important}
    .text-primary,.border-primary{color:var(--color-primary)!important;border-color:var(--color-primary)!important}
    .text-accent{color:var(--color-accent)!important}
    .btn-accent{background:var(--color-accent);border-color:var(--color-accent);color:#fff;transition:var(--color-hover-transition)}
    .btn-accent:hover{background:var(--color-accent-light);border-color:var(--color-accent-light);color:#fff}
    .login-card{max-width:420px;width:100%;animation:fadeIn .8s ease-out}
    .module-card{transition:var(--color-hover-transition);box-shadow:0 4px 12px rgba(0,0,0,.08)!important;cursor:pointer;border:1px solid #dee2e6}
    .module-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)!important;border-color:var(--color-accent)!important}
    .dashboard-card{transition:var(--color-hover-transition);border:none;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .data-table-responsive{overflow-x:auto}
    .data-table-responsive table{min-width:700px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    #dashboard-container,#module-content-container{animation:fadeIn .8s ease-out}
  </style>
</head>
<body>

  <!-- Topbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary-dark shadow-sm sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#" onclick="checkLoginStatus(true);return false;">
        <i class="fas fa-hospital me-2 text-accent"></i>HMS
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active dashboard-link d-none" href="#" onclick="showDashboard(sessionStorage.getItem('hms_user_role'));return false;">
              <i class="fas fa-home me-1"></i>Dashboard
            </a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link d-none logout-link" href="#" onclick="logout();return false;">
              <i class="fas fa-sign-out-alt text-danger me-1"></i>Logout (<span id="user-role-display"></span>)
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-5">

    <!-- Login -->
    <section id="login-section" class="d-flex justify-content-center align-items-center" style="min-height:70vh;">
      <div class="login-card p-4 shadow-lg bg-white rounded">
        <h3 class="text-primary mb-4 text-center">
          <i class="fas fa-sign-in-alt me-2 text-accent"></i>Login to HMS
        </h3>
        <form id="login-form">
          <div class="mb-3">
            <input type="email" id="login-email" class="form-control" placeholder="Email" value="admin@hms.com" required>
          </div>
          <div class="mb-3">
            <input type="password" id="login-password" class="form-control" placeholder="Password" value="123" required>
          </div>
          <div class="mb-4">
            <select id="login-role" class="form-select">
              <option value="Admin">Admin</option>
              <option value="Doctor">Doctor</option>
              <option value="Patient">Patient</option>
            </select>
          </div>
          <button class="btn btn-accent w-100 fw-bold" type="submit">Login</button>
          <div id="login-message" class="mt-3 text-center text-danger d-none">
            Invalid Credentials. Try role: Admin, pass: 123
          </div>
        </form>
      </div>
    </section>

    <!-- Module cards (shown on homepage & cloned into Admin dashboard) -->
    <section id="module-breakdown-section" class="my-5">
      <h2 class="text-center text-primary mb-5 display-6 fw-bold">⚙️ Module Breakdown</h2>
      <div class="row g-4" id="module-cards-row">
        <div class="col-lg-3 col-md-6">
          <div class="card module-card h-100 border-start border-info border-5" data-module="PatientManagement">
            <div class="card-body">
              <i class="fas fa-user-injured fa-2x text-info mb-3"></i>
              <h5 class="card-title text-primary fw-bold">Patient Management</h5>
              <p class="card-text text-muted small">Registration, demographics, history tracking, and visits.</p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card module-card h-100 border-start border-primary border-5" data-module="AppointmentScheduling">
            <div class="card-body">
              <i class="fas fa-calendar-alt fa-2x text-primary mb-3"></i>
              <h5 class="card-title text-primary fw-bold">Appointment Scheduling</h5>
              <p class="card-text text-muted small">Booking, rescheduling, and doctor availability.</p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card module-card h-100 border-start border-primary border-5" data-module="EMR">
            <div class="card-body">
              <i class="fas fa-file-medical-alt fa-2x text-primary mb-3"></i>
              <h5 class="card-title text-primary fw-bold">Electronic Medical Records</h5>
              <p class="card-text text-muted small">Diagnoses, treatment plans, and history.</p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card module-card h-100 border-start border-success border-5" data-module="BillingInsurance">
            <div class="card-body">
              <i class="fas fa-file-invoice-dollar fa-2x text-success mb-3"></i>
              <h5 class="card-title text-primary fw-bold">Billing & Insurance</h5>
              <p class="card-text text-muted small">Billing, claims processing, payment tracking.</p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card module-card h-100 border-start border-warning border-5" data-module="LIS">
            <div class="card-body">
              <i class="fas fa-flask fa-2x text-warning mb-3"></i>
              <h5 class="card-title text-primary fw-bold">Lab Information System</h5>
              <p class="card-text text-muted small">Orders, sample tracking, and results.</p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card module-card h-100 border-start border-danger border-5" data-module="PharmacyManagement">
            <div class="card-body">
              <i class="fas fa-pills fa-2x text-danger mb-3"></i>
              <h5 class="card-title text-primary fw-bold">Pharmacy Management</h5>
              <p class="card-text text-muted small">Inventory, dispensing, and expiry tracking.</p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card module-card h-100 border-start border-secondary border-5" data-module="StaffResource">
            <div class="card-body">
              <i class="fas fa-users-cog fa-2x text-secondary mb-3"></i>
              <h5 class="card-title text-primary fw-bold">Staff & Resources</h5>
              <p class="card-text text-muted small">Scheduling, roles, and assignments.</p>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="card module-card h-100 border-start border-dark border-5" data-module="Reporting">
            <div class="card-body">
              <i class="fas fa-chart-line fa-2x text-dark mb-3"></i>
              <h5 class="card-title text-primary fw-bold">Administration & Reporting</h5>
              <p class="card-text text-muted small">Config, users, analytics, and exports.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Module shell (content is injected per module) -->
    <section id="module-content-container" class="my-5 p-4 bg-white shadow rounded d-none">
      <h2 id="module-content-title" class="text-accent border-bottom pb-2 mb-4"></h2>
      <div id="module-content-body"></div>
      <button class="btn btn-sm btn-outline-secondary mt-4" onclick="checkLoginStatus(true)">
        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
      </button>
    </section>

    <!-- Dashboard container (Admin/Doctor/Patient) -->
    <section id="dashboard-container" class="my-5 p-3 d-none"></section>
  </main>

  <footer class="bg-primary-dark text-white text-center p-3 mt-auto">
    Hospital Management System | **Copyright @2025**
  </footer>

  <!-- JS libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- === PAGE UI LOGIC (no API helpers here) === -->
  <script>
    // Demo auth
    const validCredentials = { Admin:'123', Doctor:'123', Patient:'123' };

    // Module templates (HTML only). The actual wiring & API calls are in script.js
    const moduleContentMap = {
      PatientManagement: {
        icon:'fas fa-user-injured', title:'Patient Management',
        content: `
          <div class="alert alert-info border-start border-5">
            <i class="fas fa-database me-2"></i>
            Connected to backend <code>/api/patients</code>. List and add patients below.
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 text-primary">Patients</h5>
            <button id="reloadPatientsBtn" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-rotate me-1"></i> Reload
            </button>
          </div>
          <div class="data-table-responsive">
            <table id="patientsTable" class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Age</th><th>Gender</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <h6 class="mt-4 text-accent">Add a new patient</h6>
          <form id="addPatientForm" class="row g-2">
            <div class="col-md-4"><input id="p_name" class="form-control" placeholder="Name" required></div>
            <div class="col-md-3"><input id="p_age" type="number" class="form-control" placeholder="Age"></div>
            <div class="col-md-3"><input id="p_gender" class="form-control" placeholder="Gender (M/F)"></div>
            <div class="col-md-2 d-grid"><button class="btn btn-accent" type="submit"><i class="fas fa-plus me-1"></i> Save</button></div>
          </form>`
      },

      AppointmentScheduling: {
        icon:'fas fa-calendar-alt', title:'Appointment Scheduling',
        content: `
          <div class="alert alert-info border-start border-5">
            <i class="fas fa-database me-2"></i>
            Connected to backend <code>/api/appointments</code>. List and add appointments below.
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 text-primary">Appointments</h5>
            <button id="reloadApptsBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate me-1"></i> Reload</button>
          </div>
          <div class="data-table-responsive">
            <table id="apptsTable" class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>ID</th><th>Date</th><th>Status</th><th>Doctor ID</th><th>Patient ID</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <h6 class="mt-4 text-accent">Add a new appointment</h6>
          <form id="addApptForm" class="row g-2">
            <div class="col-md-3"><input id="a_date" type="date" class="form-control" required></div>
            <div class="col-md-3"><input id="a_status" class="form-control" placeholder="Status (e.g. SCHEDULED)"></div>
            <div class="col-md-3"><input id="a_doctor" type="number" class="form-control" placeholder="Doctor ID" required></div>
            <div class="col-md-3"><input id="a_patient" type="number" class="form-control" placeholder="Patient ID" required></div>
            <div class="col-12 d-grid mt-2"><button class="btn btn-accent" type="submit"><i class="fas fa-plus me-1"></i> Save</button></div>
          </form>`
      },

      EMR: {
        icon:'fas fa-file-medical-alt', title:'Electronic Medical Records',
        content: `
          <div class="alert alert-info border-start border-5">
            <i class="fas fa-database me-2"></i>
            Connected to backend <code>/api/emr</code>. List and add EMR notes below.
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 text-primary">EMR Records</h5>
            <div class="input-group" style="max-width:320px;">
              <input id="filterEmrPatientId" class="form-control" type="number" placeholder="Filter by Patient ID">
              <button id="reloadEmrBtn" class="btn btn-outline-secondary">Reload</button>
            </div>
          </div>
          <div class="data-table-responsive">
            <table id="emrTable" class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>ID</th><th>Date</th><th>Diagnosis</th><th>Treatment</th><th>Patient</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <h6 class="mt-4 text-accent">Add EMR</h6>
          <form id="addEMRForm" class="row g-2">
            <div class="col-md-3"><input id="e_date" type="date" class="form-control" required></div>
            <div class="col-md-3"><input id="e_diagnosis" class="form-control" placeholder="Diagnosis" required></div>
            <div class="col-md-3"><input id="e_treatment" class="form-control" placeholder="Treatment"></div>
            <div class="col-md-3"><input id="e_patient" type="number" class="form-control" placeholder="Patient ID" required></div>
            <div class="col-12"><textarea id="e_notes" class="form-control" placeholder="Notes"></textarea></div>
            <div class="col-12 d-grid mt-2"><button class="btn btn-accent" type="submit"><i class="fas fa-plus me-1"></i> Save</button></div>
          </form>`
      },

      BillingInsurance: {
        icon:'fas fa-file-invoice-dollar', title:'Billing & Insurance',
        content: `
          <div class="alert alert-info border-start border-5">
            <i class="fas fa-database me-2"></i>
            Connected to backend <code>/api/billing</code>. List and add billing records below.
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 text-primary">Billing Records</h5>
            <div class="input-group" style="max-width:260px;">
              <input id="filterBillPatientId" class="form-control" type="number" placeholder="Filter by Patient ID">
              <button id="reloadBillingBtn" class="btn btn-outline-secondary">Reload</button>
            </div>
          </div>
          <div class="data-table-responsive">
            <table id="billingTable" class="table table-striped table-bordered">
              <thead class="table-light">
                <tr><th>ID</th><th>Date</th><th>Patient</th><th>Amount</th><th>Payment Method</th><th>Insurance</th><th>Status</th><th>Remarks</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <h6 class="mt-4 text-accent">Add a new bill</h6>
          <form id="addBillForm" class="row g-2">
            <div class="col-md-3"><input id="b_date" type="date" class="form-control" required></div>
            <div class="col-md-3"><input id="b_patient" type="number" class="form-control" placeholder="Patient ID" required></div>
            <div class="col-md-2"><input id="b_amount" type="number" step="0.01" class="form-control" placeholder="Amount" required></div>
            <div class="col-md-2">
              <select id="b_payment" class="form-select"><option>Cash</option><option>Card</option><option>Insurance</option></select>
            </div>
            <div class="col-md-2"><input id="b_insurance" class="form-control" placeholder="Insurance Provider"></div>
            <div class="col-md-3"><input id="b_status" class="form-control" placeholder="Claim Status"></div>
            <div class="col-md-9"><input id="b_remarks" class="form-control" placeholder="Remarks"></div>
            <div class="col-12 d-grid mt-2"><button class="btn btn-accent" type="submit"><i class="fas fa-plus me-1"></i> Save</button></div>
          </form>`
      },

      LIS: {
        icon:'fas fa-flask', title:'Laboratory Information System',
        content: `
          <div class="alert alert-info border-start border-5">
            <i class="fas fa-database me-2"></i>
            Connected to backend <code>/api/lab/orders</code>. List and create lab orders.
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 text-primary">Lab Orders</h5>
            <button id="reloadLabOrdersBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate me-1"></i> Reload</button>
          </div>
          <div class="data-table-responsive">
            <table id="labOrdersTable" class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>ID</th><th>Date</th><th>Status</th><th>Sample</th><th>Test</th><th>Patient</th><th>Doctor</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <h6 class="mt-4 text-accent">Create Lab Order</h6>
          <form id="addLabOrderForm" class="row g-2">
            <div class="col-md-3"><input id="l_date" type="date" class="form-control" required></div>
            <div class="col-md-3">
              <select id="l_status" class="form-select">
                <option>ORDERED</option><option>COLLECTED</option><option>IN_PROGRESS</option>
                <option>COMPLETED</option><option>CANCELLED</option>
              </select>
            </div>
            <div class="col-md-2"><input id="l_sample" class="form-control" placeholder="Sample ID (optional)"></div>
            <div class="col-md-1"><input id="l_test" type="number" class="form-control" placeholder="Test ID" required></div>
            <div class="col-md-1"><input id="l_patient" type="number" class="form-control" placeholder="Patient ID" required></div>
            <div class="col-md-1"><input id="l_doctor" type="number" class="form-control" placeholder="Doctor ID" required></div>
            <div class="col-md-1 d-grid"><button class="btn btn-accent" type="submit"><i class="fas fa-plus me-1"></i> Save</button></div>
          </form>`
      },

      PharmacyManagement: {
        icon:'fas fa-pills', title:'Pharmacy Management',
        content: `
          <div class="alert alert-info border-start border-5">
            <i class="fas fa-database me-2"></i>
            Connected to backend <code>/api/pharmacy</code>. Manage inventory below.
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 text-primary">Medicines</h5>
            <button id="reloadMedsBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate me-1"></i> Reload</button>
          </div>
          <div class="data-table-responsive">
            <table id="medsTable" class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Batch</th><th>Qty</th><th>Price</th><th>Expiry</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <h6 class="mt-4 text-accent">Add Medicine</h6>
          <form id="addMedForm" class="row g-2">
            <div class="col-md-3"><input id="m_name" class="form-control" placeholder="Name" required></div>
            <div class="col-md-2"><input id="m_batch" class="form-control" placeholder="Batch No."></div>
            <div class="col-md-2"><input id="m_qty" type="number" class="form-control" placeholder="Qty" required></div>
            <div class="col-md-2"><input id="m_price" type="number" step="0.01" class="form-control" placeholder="Price" required></div>
            <div class="col-md-3"><input id="m_exp" class="form-control" placeholder="Expiry (YYYY-MM-DD)"></div>
            <div class="col-12 d-grid mt-2"><button class="btn btn-accent" type="submit"><i class="fas fa-plus me-1"></i> Save</button></div>
          </form>`
      },


            
      StaffResource: {
        icon:'fas fa-users-cog', title:'Staff & Resources',
        content: `
          <div class="alert alert-info border-start border-5">
            <i class="fas fa-database me-2"></i>
            Connected to backend <code>/api/staff</code>. Manage staff below.
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 text-primary">Staff</h5>
            <button id="reloadStaffBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate me-1"></i> Reload</button>
          </div>
          <div class="data-table-responsive">
            <table id="staffTable" class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Role</th><th>Shift</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <h6 class="mt-4 text-accent">Add Staff</h6>
          <form id="addStaffForm" class="row g-2">
            <div class="col-md-4"><input id="s_name" class="form-control" placeholder="Name" required></div>
            <div class="col-md-4"><input id="s_role" class="form-control" placeholder="Role (Nurse, Technician, ...)"></div>
            <div class="col-md-3"><input id="s_shift" class="form-control" placeholder="Shift (Day/Night)"></div>
            <div class="col-md-1 d-grid"><button class="btn btn-accent" type="submit"><i class="fas fa-plus me-1"></i> Save</button></div>
          </form>`
      },


      Reporting: {
        icon:'fas fa-chart-line', title:'Administration & Reporting',
        content: `
          <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#settings"><i class="fas fa-sliders-h me-1"></i> System Configuration</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#users"><i class="fas fa-users-cog me-1"></i> User Management</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#analytics"><i class="fas fa-chart-bar me-1"></i> Analytics</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#reports"><i class="fas fa-file-export me-1"></i> Reports</button></li>
          </ul>

          <div class="tab-content">
            <!-- SETTINGS -->
            <div class="tab-pane fade show active" id="settings">
              <div class="alert alert-info border-start border-5 mb-3"><i class="fas fa-database me-2"></i> Connected to <code>/api/admin/settings</code>.</div>
              <form id="settingsForm" class="row g-3">
                <div class="col-md-4"><label class="form-label">Hospital Name</label><input id="set_name" class="form-control" placeholder="eg. City General Hospital" required></div>
                <div class="col-md-4"><label class="form-label">Timezone</label><input id="set_tz" class="form-control" placeholder="eg. Asia/Kolkata" required></div>
                <div class="col-md-4"><label class="form-label">Default Locale</label><input id="set_locale" class="form-control" placeholder="eg. en-IN"></div>
                <div class="col-md-4"><label class="form-label">Enable Email</label>
                  <select id="set_email" class="form-select"><option value="true">Enabled</option><option value="false">Disabled</option></select>
                </div>
                <div class="col-md-8"><label class="form-label">Support Email</label><input id="set_support" type="email" class="form-control" placeholder="support@hospital.com"></div>
                <div class="col-12 d-flex gap-2">
                  <button class="btn btn-accent" type="submit"><i class="fas fa-save me-1"></i> Save Settings</button>
                  <button id="reloadSettingsBtn" class="btn btn-outline-secondary" type="button"><i class="fas fa-rotate me-1"></i> Reload</button>
                </div>
              </form>
            </div>

            <!-- USERS -->
            <div class="tab-pane fade" id="users">
              <div class="alert alert-info border-start border-5 mb-3"><i class="fas fa-database me-2"></i> Connected to <code>/api/admin/users</code>.</div>
              <div class="data-table-responsive mb-3">
                <table id="usersTable" class="table table-striped table-bordered">
                  <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th style="width:110px;">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <h6 class="text-accent">Add User</h6>
              <form id="addUserForm" class="row g-2">
                <div class="col-md-3"><input id="u_name" class="form-control" placeholder="Name" required></div>
                <div class="col-md-3"><input id="u_email" type="email" class="form-control" placeholder="Email" required></div>
                <div class="col-md-2">
                  <select id="u_role" class="form-select"><option>Admin</option><option>Doctor</option><option>Staff</option><option>Patient</option></select>
                </div>
                <div class="col-md-2"><input id="u_password" type="password" class="form-control" placeholder="Temp Password" required></div>
                <div class="col-md-2 d-grid"><button class="btn btn-accent" type="submit"><i class="fas fa-user-plus me-1"></i> Create</button></div>
              </form>
            </div>

            <!-- ANALYTICS -->
            <div class="tab-pane fade" id="analytics">
              <div class="alert alert-info border-start border-5 mb-3"><i class="fas fa-database me-2"></i> Using <code>/api/report</code> for KPIs.</div>
              <div class="row g-3 mb-4" id="kpiCards"></div>
              <div class="card p-3 shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="m-0 text-primary">Monthly Activity</h6>
                  <button id="reloadAnalyticsBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-rotate me-1"></i> Reload</button>
                </div>
                <canvas id="miniBar" height="120"></canvas>
                <div id="monthlyActivityBox" class="mt-2 small"></div>

              </div>
            </div>

            <!-- REPORTS -->
            <div class="tab-pane fade" id="reports">
              <div class="alert alert-info border-start border-5 mb-3"><i class="fas fa-database me-2"></i> Generate CSV from <code>/api/report</code> (client-side).</div>
              <form id="exportForm" class="row g-2 align-items-end">
                <div class="col-md-3"><label class="form-label">From</label><input id="r_from" type="date" class="form-control"></div>
                <div class="col-md-3"><label class="form-label">To</label><input id="r_to" type="date" class="form-control"></div>
                <div class="col-md-3 d-grid"><button class="btn btn-accent" type="submit"><i class="fas fa-file-csv me-1"></i> Export CSV</button></div>
              </form>
              <div class="mt-3 small text-muted" id="exportHint"></div>
            </div>
          </div>`
      }
    };

    // Dashboard builder
    window.showDashboard = function(role){
      const moduleSection = document.getElementById('module-breakdown-section');
      const moduleContentContainer = document.getElementById('module-content-container');
      const loginSection = document.getElementById('login-section');
      const dashboard = document.getElementById('dashboard-container');
      const logoutLink = document.querySelector('.logout-link');
      const dashboardLinks = document.querySelectorAll('.dashboard-link');
      const userRoleDisplay = document.getElementById('user-role-display');

      moduleContentContainer.classList.add('d-none');
      let html = '';

      if(role==='Admin'){
        html = `
          <h2 class="text-primary mb-4"><i class="fas fa-user-shield me-2 text-accent"></i> Admin Dashboard</h2>
          <p class="lead text-muted">Manage all hospital operations and view key statistics.</p>
          <div id="module-cards-placeholder"></div>
        `;
      }else if(role==='Doctor'){
        html = `
          <h2 class="text-primary mb-4"><i class="fas fa-user-md me-2 text-accent"></i> Doctor Dashboard</h2>
          <div class="card p-3 module-card" data-module="PatientManagement"><strong>My Patients</strong> – click to view.</div>
        `;
      }else if(role==='Patient'){
        html = `
          <h2 class="text-primary mb-4"><i class="fas fa-user-injured me-2 text-accent"></i> Patient Dashboard</h2>
          <div class="card p-3 module-card" data-module="AppointmentScheduling"><strong>Appointments</strong> – Book/reschedule.</div>
        `;
      }else{
        html = '<div class="alert alert-danger">Invalid role. Please log in again.</div>';
      }

      dashboard.innerHTML = html;
      dashboard.classList.remove('d-none');
      loginSection.classList.add('d-none');
      moduleSection.classList.add('d-none');
      logoutLink.classList.remove('d-none');
      dashboardLinks.forEach(l=>l.classList.remove('d-none'));
      userRoleDisplay.textContent = role;

      if(role==='Admin'){
        const placeholder = document.getElementById('module-cards-placeholder');
        const cardsHtml = moduleSection.querySelector('#module-cards-row').innerHTML;
        placeholder.innerHTML = `<div class="row g-4" id="admin-module-cards-row">${cardsHtml}</div>`;
      }
    };

    // Simple demo login
    document.addEventListener('DOMContentLoaded', ()=>{
      const form = document.getElementById('login-form');
      const loginMessage = document.getElementById('login-message');

      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const role = document.getElementById('login-role').value;
        const pwd  = document.getElementById('login-password').value;
        if(pwd && validCredentials[role] && pwd===validCredentials[role]){
          loginMessage.classList.add('d-none');
          sessionStorage.setItem('hms_user_role', role);
          sessionStorage.setItem('hms_token', 'demo-token'); // so auth headers exist
          showDashboard(role);
        }else{
          loginMessage.textContent = `Invalid credentials. Try role: ${role}, password: 123`;
          loginMessage.classList.remove('d-none');
        }
      });
    });

    // Logout
    window.logout = function(){
      sessionStorage.removeItem('hms_user_role');
      sessionStorage.removeItem('hms_token');
      document.getElementById('dashboard-container').classList.add('d-none');
      document.getElementById('module-content-container').classList.add('d-none');
      document.getElementById('login-section').classList.remove('d-none');
      document.getElementById('module-breakdown-section').classList.remove('d-none');
      document.querySelector('.logout-link').classList.add('d-none');
      document.querySelectorAll('.dashboard-link').forEach(l=>l.classList.add('d-none'));
    };

    // Session check
    window.checkLoginStatus = function(showDash=false){
      const role = sessionStorage.getItem('hms_user_role');
      if(role && showDash){ showDashboard(role); return; }
      if(!role){
        document.getElementById('login-section').classList.remove('d-none');
        document.getElementById('module-breakdown-section').classList.remove('d-none');
      }else{
        showDashboard(role);
      }
    };

    // Render module (inject HTML then call wire+load from script.js)
    window.renderModuleContent = function(moduleName){
      const cfg = moduleContentMap[moduleName];
      if(!cfg) return;

      document.getElementById('dashboard-container').classList.add('d-none');
      document.getElementById('module-breakdown-section').classList.add('d-none');
      document.getElementById('login-section').classList.add('d-none');

      document.getElementById('module-content-title').innerHTML = `<i class="${cfg.icon} me-2"></i> ${cfg.title}`;
      document.getElementById('module-content-body').innerHTML   = cfg.content;
      document.getElementById('module-content-container').classList.remove('d-none');

      // call helpers (they are defined in script.js)
      if(moduleName==='PatientManagement'){ uiWirePatientForm(); uiLoadPatients(); }
      else if(moduleName==='AppointmentScheduling'){ uiWireAppointmentForm(); uiLoadAppointments(); }
      else if(moduleName==='EMR'){ uiWireEMRForm(); uiLoadEMR(); }
      else if(moduleName==='BillingInsurance'){ uiWireBillingForm(); uiLoadBillings(); }
      else if(moduleName==='LIS'){ uiWireLISForm(); uiLoadLabOrders(); }
      else if(moduleName==='PharmacyManagement'){ uiWirePharmacyForm(); uiLoadMedicines(); }
      else if(moduleName==='StaffResource'){ uiWireStaffForm(); uiLoadStaff(); }
      else if(moduleName==='Reporting'){ uiInitAdminReporting(); }
    };

    // Global clicks for module cards
    document.addEventListener('click', (e)=>{
      const card = e.target.closest('.module-card');
      if(card){
        const mod = card.getAttribute('data-module');
        if(mod) renderModuleContent(mod);
      }
    });

    // initial state
    checkLoginStatus();
  </script>

  <!-- === SINGLE include of your API/UI helpers === -->
  <script src="./script.js"></script>
  <!-- ================= SAFE FETCH PATCH ================= -->
<script>
/*
  Prevents: "undefined is not valid JSON"
  Reason  : Backend may return empty body
  Fix     : Convert empty response to []
*/
(function () {
  const originalFetch = window.fetch;

  window.fetch = async function (...args) {
    const response = await originalFetch(...args);
    const cloned = response.clone();
    const text = await cloned.text();

    if (!text || text.trim() === "") {
      return new Response("[]", {
        status: response.status,
        statusText: response.statusText,
        headers: response.headers
      });
    }
    return response;
  };
})();
</script>
<!-- ================= END PATCH ================= -->


  <!-- Optional: auto-wire if some forms exist immediately (not required for card flow) -->
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      if(document.getElementById('addPatientForm')){ uiWirePatientForm(); uiLoadPatients(); }
      if(document.getElementById('addApptForm')){ uiWireAppointmentForm(); uiLoadAppointments(); }
      if(document.getElementById('addEMRForm')){ uiWireEMRForm(); uiLoadEMR(); }
      if(document.getElementById('addBillForm')){ uiWireBillingForm(); uiLoadBillings(); }
      if(document.getElementById('addLabOrderForm')){ uiWireLISForm(); uiLoadLabOrders(); }
      if(document.getElementById('addMedForm')){ uiWirePharmacyForm(); uiLoadMedicines(); }
      if(document.getElementById('addStaffForm')){ uiWireStaffForm(); uiLoadStaff(); }
      if(document.getElementById('settingsForm')){ uiInitAdminReporting(); }
    });
  </script>
</body>
</html>
 